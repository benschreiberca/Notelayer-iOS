name: TestFlight

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggering for testing

jobs:
  testflight:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"
          bundler-cache: true
      
      - name: Validate required secrets
        run: |
          MISSING_SECRETS=""
          [ -z "${{ secrets.ASC_KEY_ID }}" ] && MISSING_SECRETS="$MISSING_SECRETS ASC_KEY_ID"
          [ -z "${{ secrets.ASC_ISSUER_ID }}" ] && MISSING_SECRETS="$MISSING_SECRETS ASC_ISSUER_ID"
          [ -z "${{ secrets.ASC_PRIVATE_KEY }}" ] && MISSING_SECRETS="$MISSING_SECRETS ASC_PRIVATE_KEY"
          [ -z "${{ secrets.MATCH_PASSWORD }}" ] && MISSING_SECRETS="$MISSING_SECRETS MATCH_PASSWORD"
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "::error::Missing required secrets:$MISSING_SECRETS"
            exit 1
          fi
          echo "âœ… All required secrets are configured"
      - name: Configure match env
        run: |
          if [ -n "${{ secrets.MATCH_GIT_URL }}" ]; then
            echo "MATCH_GIT_URL=${{ secrets.MATCH_GIT_URL }}" >> "$GITHUB_ENV"
          fi
          if [ -n "${{ secrets.MATCH_GIT_BRANCH }}" ]; then
            echo "MATCH_GIT_BRANCH=${{ secrets.MATCH_GIT_BRANCH }}" >> "$GITHUB_ENV"
          fi
          if [ -n "${{ secrets.MATCH_PASSWORD }}" ]; then
            echo "MATCH_PASSWORD=${{ secrets.MATCH_PASSWORD }}" >> "$GITHUB_ENV"
          fi
          if [ -n "${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}" ]; then
            echo "MATCH_GIT_BASIC_AUTHORIZATION=${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}" >> "$GITHUB_ENV"
          fi
          if [ -n "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" ]; then
            echo "MATCH_GIT_PRIVATE_KEY<<EOF" >> "$GITHUB_ENV"
            echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" >> "$GITHUB_ENV"
            echo "EOF" >> "$GITHUB_ENV"
          fi
      - name: Upload to TestFlight
        env:
          ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
          ASC_PRIVATE_KEY: ${{ secrets.ASC_PRIVATE_KEY }}
        run: bundle exec fastlane beta
      
      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            ~/Library/Logs/gym/
            fastlane/report.xml
            fastlane/test_output/
          if-no-files-found: ignore
