default_platform(:ios)

platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    key_content = ENV["ASC_PRIVATE_KEY"].to_s
    # Treat non-PEM key content as base64.
    is_base64 = !key_content.include?("BEGIN")
    api_key = app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: key_content,
      is_key_content_base64: is_base64
    )

    setup_ci if ENV["CI"] == "true"

    sync_code_signing(
      type: "appstore",
      app_identifier: "com.notelayer.app",
      readonly: ENV["CI"] == "true"
    )

    run_number = ENV["GITHUB_RUN_NUMBER"]
    run_attempt = ENV["GITHUB_RUN_ATTEMPT"]
    build_number = nil

    if run_number
      build_number = run_number
      if run_attempt && run_attempt != "1"
        build_number = "#{run_number}.#{run_attempt}"
      end
    end

    if build_number
      increment_build_number(
        xcodeproj: "ios-swift/Notelayer/Notelayer.xcodeproj",
        build_number: build_number
      )
    else
      increment_build_number(
        xcodeproj: "ios-swift/Notelayer/Notelayer.xcodeproj"
      )
    end

    build_app(
      project: "ios-swift/Notelayer/Notelayer.xcodeproj",
      scheme: "Notelayer",
      export_method: "app-store"
    )

    upload_to_testflight(
      api_key: api_key
    )
  end
end
